<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:PostmanClone.App.ViewModels"
             mc:Ignorable="d" d:DesignWidth="250" d:DesignHeight="600"
             x:Class="PostmanClone.App.Views.sidebar_view"
             x:DataType="vm:sidebar_view_model">

    <Grid RowDefinitions="Auto,*,Auto,*" Background="#161B22">
        <!-- Collections Header with + Button -->
        <Border Grid.Row="0" Padding="16,12">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="ðŸ“" FontSize="14"/>
                    <TextBlock Text="Collections" 
                               FontWeight="SemiBold" 
                               FontSize="13"
                               Foreground="#F0F6FC"/>
                </StackPanel>
                <Button Grid.Column="1"
                        Command="{Binding CreateCollectionCommand}"
                        Content="+"
                        Width="28"
                        Height="28"
                        FontSize="16"
                        FontWeight="Bold"
                        Padding="0"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center"
                        ToolTip.Tip="Create new collection">
                    <Button.Styles>
                        <Style Selector="Button">
                            <Setter Property="Background" Value="#238636"/>
                            <Setter Property="Foreground" Value="White"/>
                            <Setter Property="CornerRadius" Value="6"/>
                        </Style>
                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                            <Setter Property="Background" Value="#2EA043"/>
                        </Style>
                    </Button.Styles>
                </Button>
            </Grid>
        </Border>
        
        <!-- Collections Tree -->
        <TreeView Grid.Row="1" 
                  ItemsSource="{Binding Collections}"
                  SelectedItem="{Binding SelectedCollectionItem}"
                  Background="Transparent"
                  Margin="8,0">
            <TreeView.Styles>
                <Style Selector="TreeViewItem">
                    <Setter Property="Padding" Value="8,6"/>
                    <Setter Property="IsExpanded" Value="{ReflectionBinding IsExpanded, Mode=TwoWay}"/>
                </Style>
            </TreeView.Styles>
            <TreeView.ItemTemplate>
                <TreeDataTemplate ItemsSource="{Binding Children}">
                    <Border Background="Transparent" 
                            CornerRadius="6" 
                            Padding="8,6">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <!-- Icons and Name -->
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                <TextBlock Text="ðŸ“¦" IsVisible="{Binding IsCollectionRoot}" FontSize="12"/>
                                <TextBlock Text="ðŸ“" FontSize="12">
                                    <TextBlock.IsVisible>
                                        <MultiBinding Converter="{x:Static BoolConverters.And}">
                                            <Binding Path="IsFolder"/>
                                            <Binding Path="!IsCollectionRoot"/>
                                        </MultiBinding>
                                    </TextBlock.IsVisible>
                                </TextBlock>
                                <TextBlock Text="ðŸ“„" FontSize="12">
                                    <TextBlock.IsVisible>
                                        <MultiBinding Converter="{x:Static BoolConverters.And}">
                                            <Binding Path="!IsFolder"/>
                                            <Binding Path="!IsCollectionRoot"/>
                                        </MultiBinding>
                                    </TextBlock.IsVisible>
                                </TextBlock>
                                <Border Background="#238636" 
                                        CornerRadius="4" 
                                        Padding="6,2"
                                        IsVisible="{Binding Method, Converter={x:Static ObjectConverters.IsNotNull}}">
                                    <TextBlock Text="{Binding Method}" 
                                               FontWeight="Bold"
                                               FontSize="9"
                                               Foreground="#FFFFFF"/>
                                </Border>
                                <!-- Display mode: show name -->
                                <TextBlock Text="{Binding Name}" 
                                           Foreground="#C9D1D9"
                                           FontSize="12"
                                           VerticalAlignment="Center"
                                           IsVisible="{Binding !IsEditing}"
                                           DoubleTapped="OnNameDoubleTapped"/>
                                <!-- Edit mode: editable textbox -->
                                <TextBox Text="{Binding Name}" 
                                         Foreground="#C9D1D9"
                                         FontSize="12"
                                         VerticalAlignment="Center"
                                         IsVisible="{Binding IsEditing}"
                                         MinWidth="100"
                                         BorderThickness="1"
                                         BorderBrush="#58A6FF"
                                         Background="#161B22"
                                         Padding="4,2"
                                         LostFocus="OnNameEditLostFocus"
                                         KeyDown="OnNameEditKeyDown"/>
                            </StackPanel>
                            
                            <!-- Action Buttons -->
                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                                <!-- Add Request Button (only for collections) -->
                                <Button Command="{Binding $parent[TreeView].((vm:sidebar_view_model)DataContext).AddRequestToCollectionCommand}"
                                        CommandParameter="{Binding}"
                                        Width="24"
                                        Height="24"
                                        Padding="0"
                                        ToolTip.Tip="Add request to this collection"
                                        IsVisible="{Binding IsCollectionRoot, FallbackValue=False}">
                                    <Button.Content>
                                        <TextBlock Text="+" FontSize="14" FontWeight="Bold" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    </Button.Content>
                                    <Button.Styles>
                                        <Style Selector="Button">
                                            <Setter Property="Background" Value="#1F6FEB"/>
                                            <Setter Property="Foreground" Value="White"/>
                                            <Setter Property="CornerRadius" Value="4"/>
                                            <Setter Property="BorderThickness" Value="0"/>
                                        </Style>
                                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                                            <Setter Property="Background" Value="#388BFD"/>
                                        </Style>
                                    </Button.Styles>
                                </Button>
                                
                                <!-- Delete Button (show for all items) -->
                                <Button Width="24"
                                        Height="24"
                                        Padding="0"
                                        ToolTip.Tip="Delete"
                                        Command="{Binding $parent[TreeView].((vm:sidebar_view_model)DataContext).DeleteItemCommand}"
                                        CommandParameter="{Binding}">
                                    <Button.Content>
                                        <TextBlock Text="Ã—" FontSize="16" FontWeight="Bold" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    </Button.Content>
                                    <Button.Styles>
                                        <Style Selector="Button">
                                            <Setter Property="Background" Value="#DA3633"/>
                                            <Setter Property="Foreground" Value="White"/>
                                            <Setter Property="CornerRadius" Value="4"/>
                                            <Setter Property="BorderThickness" Value="0"/>
                                        </Style>
                                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                                            <Setter Property="Background" Value="#F85149"/>
                                        </Style>
                                    </Button.Styles>
                                </Button>
                            </StackPanel>
                        </Grid>
                    </Border>
                </TreeDataTemplate>
            </TreeView.ItemTemplate>
        </TreeView>

        <!-- History Header with Search -->
        <Border Grid.Row="2" 
                Padding="16,12,16,8"
                BorderBrush="#21262D"
                BorderThickness="0,1,0,0">
            <StackPanel Spacing="8">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="ðŸ•" FontSize="14"/>
                    <TextBlock Text="History" 
                               FontWeight="SemiBold" 
                               FontSize="13"
                               Foreground="#F0F6FC"/>
                </StackPanel>
                <!-- Search Box -->
                <TextBox Text="{Binding HistorySearchText}"
                         Watermark="ðŸ” Search history..."
                         FontSize="11"
                         Background="#0D1117"
                         BorderBrush="#30363D"
                         Foreground="#C9D1D9"
                         Padding="8,6"/>
                <!-- Method Filter -->
                <Grid ColumnDefinitions="*,Auto">
                    <ComboBox Grid.Column="0"
                              ItemsSource="{Binding available_method_filters}"
                              SelectedItem="{Binding HistoryMethodFilter}"
                              FontSize="11"
                              Background="#0D1117"
                              BorderBrush="#30363D"
                              Foreground="#C9D1D9"
                              HorizontalAlignment="Stretch">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding, TargetNullValue='All Methods'}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                    <Button Grid.Column="1"
                            Command="{Binding ClearHistoryFilterCommand}"
                            Content="Clear"
                            FontSize="10"
                            Padding="8,4"
                            Margin="4,0,0,0"
                            Background="#21262D"
                            Foreground="#C9D1D9"
                            BorderBrush="#30363D">
                        <Button.Styles>
                            <Style Selector="Button:pointerover /template/ ContentPresenter">
                                <Setter Property="Background" Value="#30363D"/>
                            </Style>
                        </Button.Styles>
                    </Button>
                </Grid>
            </StackPanel>
        </Border>
        
        <!-- History List -->
        <ListBox Grid.Row="3" 
                 ItemsSource="{Binding History}"
                 SelectedItem="{Binding SelectedHistoryItem}"
                 Background="Transparent"
                 Margin="8,0,8,8">
            <ListBox.Styles>
                <Style Selector="ListBoxItem">
                    <Setter Property="Padding" Value="0"/>
                    <Setter Property="Margin" Value="0,0,0,4"/>
                </Style>
                <Style Selector="ListBoxItem:selected /template/ ContentPresenter">
                    <Setter Property="Background" Value="#21262D"/>
                </Style>
            </ListBox.Styles>
            <ListBox.ItemTemplate>
                <DataTemplate x:DataType="vm:history_item_view_model">
                    <Border Background="#0D1117" 
                            CornerRadius="8" 
                            Padding="12,10"
                            BorderBrush="#21262D"
                            BorderThickness="1">
                        <Grid RowDefinitions="Auto,Auto,Auto">
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8">
                                <Border Background="#238636" 
                                        CornerRadius="4" 
                                        Padding="6,2">
                                    <TextBlock Text="{Binding Method}" 
                                               FontWeight="Bold"
                                               FontSize="9"
                                               Foreground="#FFFFFF"/>
                                </Border>
                                <Border Background="#1F6FEB" 
                                        CornerRadius="4" 
                                        Padding="6,2">
                                    <TextBlock Text="{Binding StatusCode}" 
                                               FontSize="9"
                                               FontWeight="SemiBold"
                                               Foreground="#FFFFFF"/>
                                </Border>
                            </StackPanel>
                            <TextBlock Grid.Row="1" 
                                       Text="{Binding Url}" 
                                       FontSize="11"
                                       TextTrimming="CharacterEllipsis"
                                       Foreground="#8B949E"
                                       Margin="0,6,0,4"
                                       FontFamily="JetBrains Mono, Consolas, monospace"/>
                            <TextBlock Grid.Row="2"
                                       Text="{Binding ExecutedAt, StringFormat={}{0:g}}" 
                                       FontSize="10"
                                       Foreground="#484F58"/>
                        </Grid>
                    </Border>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>
    </Grid>
</UserControl>
