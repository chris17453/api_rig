<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:App.ViewModels"
             xmlns:views="using:App.Views"
             xmlns:models="using:Core.Models"
             mc:Ignorable="d" d:DesignWidth="280" d:DesignHeight="600"
             x:Class="App.Views.side_panel_view"
             x:DataType="vm:side_panel_view_model">

    <Border Background="{DynamicResource PanelBackgroundBrush}"
            BorderBrush="{DynamicResource BorderBrush}"
            BorderThickness="0,0,1,0"
            Width="280">
        <Grid RowDefinitions="Auto,*">
            <!-- Panel Header -->
            <Border Grid.Row="0"
                    Background="{DynamicResource PanelHeaderBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="0,0,0,1"
                    Padding="12,8">
                <TextBlock Text="{Binding PanelTitle}"
                           FontWeight="SemiBold"
                           FontSize="13"
                           Foreground="{DynamicResource TextPrimaryBrush}"/>
            </Border>

            <!-- Panel Content -->
            <Grid Grid.Row="1">
                <!-- Collections Panel -->
                <views:sidebar_view IsVisible="{Binding $parent[Grid].((vm:side_panel_view_model)DataContext).IsCollectionsVisible}"
                                    DataContext="{Binding CollectionsPanel}"/>

                <!-- Environments Panel -->
                <ScrollViewer IsVisible="{Binding IsEnvironmentsVisible}"
                              VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="8">
                        <!-- Active Environment -->
                        <Border Background="{DynamicResource AccentBrush}"
                                CornerRadius="4"
                                Padding="8"
                                Margin="0,0,0,8"
                                IsVisible="{Binding EnvironmentsPanel.ActiveEnvironment, Converter={x:Static ObjectConverters.IsNotNull}}">
                            <StackPanel>
                                <TextBlock Text="Active Environment"
                                           FontSize="10"
                                           Opacity="0.7"
                                           Foreground="White"/>
                                <TextBlock Text="{Binding EnvironmentsPanel.ActiveEnvironment.Name}"
                                           FontSize="12"
                                           FontWeight="SemiBold"
                                           Foreground="White"/>
                            </StackPanel>
                        </Border>

                        <!-- Create Button -->
                        <Button Classes="panel-action-btn"
                                Command="{Binding EnvironmentsPanel.CreateEnvironmentCommand}"
                                HorizontalAlignment="Stretch"
                                Margin="0,0,0,8">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="+" FontSize="14"/>
                                <TextBlock Text="New Environment" FontSize="11"/>
                            </StackPanel>
                        </Button>

                        <!-- Environment List -->
                        <ItemsControl ItemsSource="{Binding EnvironmentsPanel.Environments}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="vm:environment_list_item">
                                    <Button Classes="list-item-btn"
                                            Command="{Binding $parent[ItemsControl].((vm:side_panel_view_model)DataContext).EnvironmentsPanel.SelectEnvironmentCommand}"
                                            CommandParameter="{Binding}">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <TextBlock Grid.Column="0"
                                                       Text="{Binding Name}"
                                                       FontSize="12"
                                                       VerticalAlignment="Center"/>
                                            <TextBlock Grid.Column="1"
                                                       Text="â—"
                                                       FontSize="8"
                                                       Foreground="{DynamicResource AccentBrush}"
                                                       VerticalAlignment="Center"
                                                       IsVisible="{Binding IsActive}"/>
                                        </Grid>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </ScrollViewer>

                <!-- History Panel -->
                <Grid IsVisible="{Binding IsHistoryVisible}"
                      RowDefinitions="Auto,*">
                    <!-- Clear Button -->
                    <Button Grid.Row="0"
                            Classes="panel-action-btn"
                            Command="{Binding HistoryPanel.ClearHistoryCommand}"
                            HorizontalAlignment="Right"
                            Margin="8">
                        <TextBlock Text="Clear" FontSize="11"/>
                    </Button>

                    <!-- History Groups -->
                    <ScrollViewer Grid.Row="1"
                                  VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding HistoryPanel.HistoryGroups}"
                                      Margin="8,0">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="vm:history_group">
                                    <StackPanel Margin="0,0,0,8">
                                        <!-- Date Header -->
                                        <TextBlock Text="{Binding DateLabel}"
                                                   FontSize="11"
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                                   Margin="4,4,0,4"/>

                                        <!-- Entries -->
                                        <ItemsControl ItemsSource="{Binding Entries}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="models:history_entry_model">
                                                    <Button Classes="history-item-btn"
                                                            Command="{Binding $parent[ScrollViewer].((vm:side_panel_view_model)DataContext).HistoryPanel.SelectEntryCommand}"
                                                            CommandParameter="{Binding}">
                                                        <Grid RowDefinitions="Auto,Auto">
                                                            <!-- Row 1: Method + Request Name + Time -->
                                                            <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto">
                                                                <Border Grid.Column="0"
                                                                        Background="{Binding method, Converter={StaticResource MethodColorConverter}}"
                                                                        CornerRadius="2"
                                                                        Padding="4,2"
                                                                        Margin="0,0,6,0">
                                                                    <TextBlock Text="{Binding method}"
                                                                               FontSize="9"
                                                                               FontWeight="Bold"
                                                                               Foreground="White"/>
                                                                </Border>
                                                                <TextBlock Grid.Column="1"
                                                                           Text="{Binding request_name}"
                                                                           FontSize="11"
                                                                           FontWeight="SemiBold"
                                                                           TextTrimming="CharacterEllipsis"
                                                                           VerticalAlignment="Center"
                                                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                                <TextBlock Grid.Column="2"
                                                                           Text="{Binding executed_at, StringFormat='{}{0:HH:mm}'}"
                                                                           FontSize="10"
                                                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                                                           VerticalAlignment="Center"/>
                                                            </Grid>
                                                            <!-- Row 2: Collection Name (if available) -->
                                                            <TextBlock Grid.Row="1"
                                                                       Text="{Binding collection_name}"
                                                                       FontSize="10"
                                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                                       TextTrimming="CharacterEllipsis"
                                                                       Margin="0,2,0,0"
                                                                       IsVisible="{Binding collection_name, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                                        </Grid>
                                                    </Button>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>

                <!-- Vault Panel -->
                <Grid IsVisible="{Binding IsVaultVisible}"
                      RowDefinitions="Auto,*">
                    <!-- Vault Header -->
                    <StackPanel Grid.Row="0" Margin="8">
                        <!-- Lock/Unlock Status -->
                        <Border Background="{DynamicResource InputBackgroundBrush}"
                                CornerRadius="4"
                                Padding="8"
                                Margin="0,0,0,8">
                            <Grid ColumnDefinitions="*,Auto">
                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="6">
                                    <TextBlock Text="{Binding VaultPanel.IsUnlocked, Converter={StaticResource BoolToLockIconConverter}}"
                                               FontSize="14"/>
                                    <TextBlock Text="{Binding VaultPanel.IsUnlocked, Converter={StaticResource BoolToLockTextConverter}}"
                                               FontSize="11"
                                               VerticalAlignment="Center"/>
                                </StackPanel>
                                <Button Grid.Column="1"
                                        Classes="panel-action-btn"
                                        Command="{Binding VaultPanel.UnlockVaultCommand}"
                                        IsVisible="{Binding !VaultPanel.IsUnlocked}">
                                    <TextBlock Text="Unlock" FontSize="11"/>
                                </Button>
                                <Button Grid.Column="1"
                                        Classes="panel-action-btn"
                                        Command="{Binding VaultPanel.LockVaultCommand}"
                                        IsVisible="{Binding VaultPanel.IsUnlocked}">
                                    <TextBlock Text="Lock" FontSize="11"/>
                                </Button>
                            </Grid>
                        </Border>

                        <!-- Create Secret Button -->
                        <Button Classes="panel-action-btn"
                                Command="{Binding VaultPanel.CreateSecretCommand}"
                                HorizontalAlignment="Stretch"
                                IsEnabled="{Binding VaultPanel.IsUnlocked}">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="+" FontSize="14"/>
                                <TextBlock Text="New Secret" FontSize="11"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <!-- Secrets List -->
                    <ScrollViewer Grid.Row="1"
                                  VerticalScrollBarVisibility="Auto"
                                  IsEnabled="{Binding VaultPanel.IsUnlocked}">
                        <ItemsControl ItemsSource="{Binding VaultPanel.Secrets}"
                                      Margin="8,0">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate DataType="vm:vault_secret_item">
                                    <Button Classes="list-item-btn"
                                            Command="{Binding $parent[ItemsControl].((vm:side_panel_view_model)DataContext).VaultPanel.SelectSecretCommand}"
                                            CommandParameter="{Binding}">
                                        <Grid ColumnDefinitions="Auto,*">
                                            <TextBlock Grid.Column="0"
                                                       Text="ðŸ”‘"
                                                       FontSize="12"
                                                       Margin="0,0,8,0"/>
                                            <StackPanel Grid.Column="1">
                                                <TextBlock Text="{Binding Name}"
                                                           FontSize="12"/>
                                                <TextBlock Text="{Binding SecretType}"
                                                           FontSize="10"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </StackPanel>
                                        </Grid>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Grid>
        </Grid>
    </Border>

    <UserControl.Styles>
        <Style Selector="Button.panel-action-btn">
            <Setter Property="Background" Value="{DynamicResource ButtonBackgroundBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="Padding" Value="8,6"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
        </Style>
        <Style Selector="Button.panel-action-btn:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource ButtonHoverBrush}"/>
        </Style>

        <Style Selector="Button.list-item-btn">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="8,6"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
        </Style>
        <Style Selector="Button.list-item-btn:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource ListItemHoverBrush}"/>
        </Style>

        <Style Selector="Button.history-item-btn">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
        </Style>
        <Style Selector="Button.history-item-btn:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="{DynamicResource ListItemHoverBrush}"/>
        </Style>

        <Style Selector="Border.history-item:pointerover">
            <Setter Property="Background" Value="{DynamicResource ListItemHoverBrush}"/>
        </Style>
    </UserControl.Styles>
</UserControl>
