<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:App.ViewModels"
             mc:Ignorable="d" d:DesignWidth="250" d:DesignHeight="600"
             x:Class="App.Views.sidebar_view"
             x:DataType="vm:sidebar_view_model">

    <Grid RowDefinitions="Auto,*" Background="{DynamicResource SidebarBackgroundBrush}">
        <!-- Collections Header with + Button -->
        <Border Grid.Row="0" Padding="8,6">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="4">
                    <TextBlock Text="+" FontSize="11" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                    <TextBlock Text="New Collection"
                               FontWeight="SemiBold"
                               FontSize="11"
                               Foreground="{DynamicResource TextPrimaryBrush}"
                               Cursor="Hand"
                               PointerPressed="OnNewCollectionClick"/>
                </StackPanel>
                <Button Grid.Column="1"
                        Command="{Binding CreateCollectionCommand}"
                        Content="+"
                        Width="20"
                        Height="20"
                        FontSize="12"
                        FontWeight="Bold"
                        Padding="0"
                        HorizontalContentAlignment="Center"
                        VerticalContentAlignment="Center"
                        ToolTip.Tip="Create new collection">
                    <Button.Styles>
                        <Style Selector="Button">
                            <Setter Property="Background" Value="{DynamicResource SuccessBrush}"/>
                            <Setter Property="Foreground" Value="White"/>
                            <Setter Property="CornerRadius" Value="4"/>
                        </Style>
                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                            <Setter Property="Background" Value="{DynamicResource SuccessHoverBrush}"/>
                        </Style>
                    </Button.Styles>
                </Button>
            </Grid>
        </Border>

        <!-- Collections Tree -->
        <TreeView Grid.Row="1"
                  ItemsSource="{Binding Collections}"
                  SelectedItem="{Binding SelectedCollectionItem}"
                  Background="Transparent"
                  Margin="4,0">
            <TreeView.Styles>
                <Style Selector="TreeViewItem">
                    <Setter Property="Padding" Value="2,1"/>
                    <Setter Property="MinHeight" Value="24"/>
                    <Setter Property="IsExpanded" Value="{ReflectionBinding IsExpanded, Mode=TwoWay}"/>
                </Style>
            </TreeView.Styles>
            <TreeView.ItemTemplate>
                <TreeDataTemplate ItemsSource="{Binding Children}">
                    <Border Background="Transparent"
                            CornerRadius="4"
                            Padding="4,2">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <!-- Icons and Name -->
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                                <TextBlock Text="ðŸ“¦" IsVisible="{Binding IsCollectionRoot}" FontSize="10"/>
                                <TextBlock Text="ðŸ“" FontSize="10">
                                    <TextBlock.IsVisible>
                                        <MultiBinding Converter="{x:Static BoolConverters.And}">
                                            <Binding Path="IsFolder"/>
                                            <Binding Path="!IsCollectionRoot"/>
                                        </MultiBinding>
                                    </TextBlock.IsVisible>
                                </TextBlock>
                                <Border Background="{DynamicResource SuccessBrush}"
                                        CornerRadius="3"
                                        Padding="4,1"
                                        IsVisible="{Binding Method, Converter={x:Static ObjectConverters.IsNotNull}}">
                                    <TextBlock Text="{Binding Method}"
                                               FontWeight="Bold"
                                               FontSize="8"
                                               Foreground="White"/>
                                </Border>
                                <!-- Display mode: show name -->
                                <TextBlock Text="{Binding Name}"
                                           Foreground="{DynamicResource ButtonTextBrush}"
                                           FontSize="11"
                                           VerticalAlignment="Center"
                                           IsVisible="{Binding !IsEditing}"
                                           DoubleTapped="OnNameDoubleTapped"/>
                                <!-- Edit mode: editable textbox -->
                                <TextBox Text="{Binding Name}"
                                         Foreground="{DynamicResource ButtonTextBrush}"
                                         FontSize="11"
                                         VerticalAlignment="Center"
                                         IsVisible="{Binding IsEditing}"
                                         MinWidth="80"
                                         BorderThickness="1"
                                         BorderBrush="{DynamicResource AccentHoverBrush}"
                                         Background="{DynamicResource CardBackgroundBrush}"
                                         Padding="2,1"
                                         LostFocus="OnNameEditLostFocus"
                                         KeyDown="OnNameEditKeyDown"/>
                            </StackPanel>

                            <!-- Action Buttons -->
                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="2" VerticalAlignment="Center">
                                <!-- Add Request Button (only for collections) -->
                                <Button Command="{Binding $parent[TreeView].((vm:sidebar_view_model)DataContext).AddRequestToCollectionCommand}"
                                        CommandParameter="{Binding}"
                                        Width="18"
                                        Height="18"
                                        Padding="0"
                                        ToolTip.Tip="Add request"
                                        IsVisible="{Binding IsCollectionRoot, FallbackValue=False}">
                                    <Button.Content>
                                        <TextBlock Text="+" FontSize="11" FontWeight="Bold" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    </Button.Content>
                                    <Button.Styles>
                                        <Style Selector="Button">
                                            <Setter Property="Background" Value="{DynamicResource AccentBrush}"/>
                                            <Setter Property="Foreground" Value="White"/>
                                            <Setter Property="CornerRadius" Value="3"/>
                                            <Setter Property="BorderThickness" Value="0"/>
                                        </Style>
                                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                                            <Setter Property="Background" Value="{DynamicResource AccentHoverBrush}"/>
                                        </Style>
                                    </Button.Styles>
                                </Button>

                                <!-- Delete Button (show for all items) -->
                                <Button Width="18"
                                        Height="18"
                                        Padding="0"
                                        ToolTip.Tip="Delete"
                                        Command="{Binding $parent[TreeView].((vm:sidebar_view_model)DataContext).DeleteItemCommand}"
                                        CommandParameter="{Binding}">
                                    <Button.Content>
                                        <TextBlock Text="x" FontSize="12" FontWeight="Bold" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    </Button.Content>
                                    <Button.Styles>
                                        <Style Selector="Button">
                                            <Setter Property="Background" Value="{DynamicResource ErrorTextBrush}"/>
                                            <Setter Property="Foreground" Value="White"/>
                                            <Setter Property="CornerRadius" Value="3"/>
                                            <Setter Property="BorderThickness" Value="0"/>
                                        </Style>
                                        <Style Selector="Button:pointerover /template/ ContentPresenter">
                                            <Setter Property="Background" Value="{DynamicResource ErrorTextBrush}"/>
                                        </Style>
                                    </Button.Styles>
                                </Button>
                            </StackPanel>
                        </Grid>
                    </Border>
                </TreeDataTemplate>
            </TreeView.ItemTemplate>
        </TreeView>
    </Grid>
</UserControl>
