name: Build Installers

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          
      - name: Install WiX Toolset
        run: |
          Invoke-WebRequest -Uri "https://github.com/wixtoolset/wix3/releases/download/wix3141rtm/wix314.exe" -OutFile wix314.exe
          Start-Process -FilePath ".\wix314.exe" -ArgumentList "/install", "/quiet", "/norestart" -Wait
          
      - name: Build Windows Installer (x64)
        run: |
          $version = "${{ github.event.inputs.version || github.ref_name }}"
          .\installer\build-installer.ps1 -Configuration Release -Platform win-x64 -Version $version
          
      - name: Upload Windows Installer (x64)
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-x64
          path: |
            installer/bin/Release/win-x64/*.msi
            publish/win-x64/
          retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          
      - name: Install dpkg-deb
        run: sudo apt-get update && sudo apt-get install -y dpkg
        
      - name: Build Linux Package (x64)
        run: |
          chmod +x ./installer/build-package.sh
          version="${{ github.event.inputs.version || github.ref_name }}"
          version="${version#v}"  # Remove 'v' prefix if present
          ./installer/build-package.sh Release "$version" linux-x64
          
      - name: Build Linux Package (ARM64)
        run: |
          version="${{ github.event.inputs.version || github.ref_name }}"
          version="${version#v}"
          ./installer/build-package.sh Release "$version" linux-arm64
          
      - name: Upload Linux Packages
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            packages/*.tar.gz
            packages/*.deb
          retention-days: 30

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          
      - name: Build macOS Package (x64)
        run: |
          chmod +x ./installer/build-package.sh
          version="${{ github.event.inputs.version || github.ref_name }}"
          version="${version#v}"
          ./installer/build-package.sh Release "$version" osx-x64
          
      - name: Build macOS Package (ARM64)
        run: |
          version="${{ github.event.inputs.version || github.ref_name }}"
          version="${version#v}"
          ./installer/build-package.sh Release "$version" osx-arm64
          
      - name: Upload macOS Packages
        uses: actions/upload-artifact@v4
        with:
          name: macos-packages
          path: |
            packages/*.app
            packages/*.dmg
          retention-days: 30

  create-release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            windows-installer-x64/*.msi
            linux-packages/*.tar.gz
            linux-packages/*.deb
            macos-packages/*.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
